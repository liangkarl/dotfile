#!/usr/bin/env bash

# $0 config-name-with-abs-path
# This tool would create new windows in current tmux session

source $(mylib file)

set -eE

usage() {
	n="$(basename $0)"
	cat <<-EOF
	NAME:
	$n - create window tabs according to wins.conf

	OPTIONS:
	-h: print help
	-t: assign win name
	-o: output sample $WIN_CONF
	-c: load $WIN_CONF in current folder
	-C: load $WIN_CONF not only in current folder but also in parent folders
	EOF
	exit $1
}

# $0 title path cmd
new_win() {
	local cmd

	cmd="new-window -n $1"
	# Assume $name is the first window name of $name session
	# create new window next to $name window, (+)
	[[ ! -z "$name" ]] && cmd+=" -t $name:+"

	if [[ ! -z "$2" ]]; then
		cmd+=" -c $2"
	fi
	cmd+="\; "

	if (( $# > 2 )); then
		shift 2
		eval tmux $cmd send-keys "'$@'" C-m \;
	else
		eval tmux $cmd
	fi
}

WIN_CONF='win.conf'

(( $# == 0 )) && usage 3

while (( $# > 0 )); do
	case "$1" in
		-h)
			usage 0
			;;
		-C)
			shift
			CONF="$(find_file_path $1)"
			;;
		-c)
			shift
			CONF="$1"
			;;
		-t)
			shift
			name="$1"
			;;
		-o)
			shift
			cat > $WIN_CONF <<-EOF
			# Format like this:
			# win=([name]='WIN NAME' [cwd]='WORKING DIR PATH' [cmd]='INIT CMD')
			EOF
			;;
		*)
			usage 2
			;;
	esac
	shift
done

[[ -z "$CONF" || ! -e "$CONF" ]] && usage 1

wd="$(readlink -e $(dirname $CONF))"

declare -A win
while IFS= read -r line; do
	eval $line
	[[ -z "${win[name]}" ]] && break

	[[ "${win[cwd]}" == ~/* ]] && win[cwd]=${win[cwd]/\~/$HOME}
	[[ "${win[cwd]}" != /* ]] && win[cwd]=$wd/${win[cwd]}

	new_win "${win[name]}" "${win[cwd]}" "${win[cmd]}"
done < "$CONF" 2> /dev/null
