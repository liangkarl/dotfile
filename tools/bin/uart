#!/bin/bash
#
# This tool based on plink.exe, a CLI version of putty
#

usage() {
	local name="$(basename $0)"

	cat <<-EOF
	name:
	    $name - A simple CLI serial console based on plink/putty

	usage:
	    $name [-low] [-n]

	options:
	    -l: list available COM port
	    -o: setup serial config
	        eg, -o "br=115200;fc=N;db=8;sb=1;pa=n"
	    -w: open with putty
	    -n: 'n' is the port number

EOF
}

list_comport() {
	ls_cmd="Get-CimInstance -Class Win32_SerialPort | Select-Object Description, DeviceID"
	$pshell -Command $ls_cmd
}

shopt -s extglob

# Required variables
pshell="powershell.exe"
plink="plink.exe"
putty="putty.exe"
bin="$plink"

# default config:
# baudrate: 961600
# flow control: no
# parity: no
# data bits: 8
# stop bits: 1
br=921600
fc=N
pa=n
db=8
sb=1
config="${br},${db},${pa},${sb},${fc}"

if (( $# == 0 )); then
	usage
	exit 2
fi

while (( $# != 0 )); do
	case $1 in
		-o)
			shift; eval "$1"
			config="${br},${db},${pa},${sb},${fc}"
			has_sercfg=''
			;;
		-l)
			list_comport
			exit
			;;
		-w)
			bin="$putty"
			;;
		-s)
			# not implement
			has_conf=''
			;;
		-+([0-9]))
			port=${1#-}
			;;
		*)
			usage
			exit 3
			;;
	esac
	shift
done

exec $bin -v -serial COM${port} -sercfg $config
