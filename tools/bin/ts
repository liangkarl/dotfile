#!/bin/bash

# this is for setting up a workspace in tmux

# TARGET_DIR=$(fasd -d $@)
TARGET_NAME="$1"

#
# ts.conf:
#
# # pos_x=('name' 'position')
# pos_1=('j90' '~/path/to/j90/project.conf/location')
#

#
# project.conf:
#
# # project name
# project='aaa'
#
# # windows setup:
# # win_1=('name' 'directory' 'command')
# win_1=('make' 'code.0' '')
# win_2=('kernel' 'path/to/kernel' '')
# win_3=('device' 'path/to/device' '')
# win_4=('lk' 'path/to/lk' '')
#

import-script file

usage() {
	local n

	n=$(basename $0)
	cat <<-EOF
	$n -p project-name
	$n -d delete-session
	$n -l
	$n -e
EOF

	exit $1
}

ls_session() {
	local file i state pos

	# import $project
	. $CONF

	# list session
	i=1
	while :; do
		pos="pos_${i}[0]"
		name="${!pos}"
		[[ -z $name ]] && break

		pos="pos_${i}[1]"
		path="${!pos}"

		if tmux has -t "$name" 2>&-; then
			state='exist'
		else
			state='none'
		fi
		pos="pos_${i}[2]"
		eval "$pos='$state'"

		echo "$i) ${name} ${state} ${path}"
		((i++))
	done
}

switch_session() {
	local cmd

	if [[ "$TMUX" == '' ]]; then # outside
		cmd='tmux attach'
	else # inside
		TMUX=''
		cmd="tmux switch-client"
	fi

	$cmd $@
	exit 0
}

edit_conf() {
	local dir confg

	dir=$(dirname $CONF)
	[[ ! -e $dir ]] && mkdir -p $dir

	file=$(basename $CONF)
	[[ ! -e $file ]] && touch $file

	vim $CONF
}

CONF="$XDG_CONFIG_HOME/tmux/plugin/ts/ts.conf"
PROJECT_LIST=()
PROJ_NAME=''
PROJ_PATH=''
PROJ_STATE=''

(( $# == 0 )) && usage 1

case $1 in
	-p)
		LIST_PROJ=y
		PROJ=y
		;;
	-d)
		LIST_PROJ=y
		DEL_PROJ=y
		;;
	-l)
		LIST_PROJ=y
		;;
	-e)
		EDIT_PROJ_CONF=y
		;;
	*)
		usage 2
		;;
esac

if [[ "$EDIT_PROJ_CONF" == y ]]; then
	edit_conf
fi

if [[ "$LIST_PROJ" == y ]]; then
	# list project name status
	ls_session
fi

if [[ ! -z "$PROJ" ]]; then
	# select project name
	read -p "select a project num to open: " proj
	proj="pos_$proj[@]"
	proj=(${!proj})
	if [[ ${!proj}:-y} == y ]]; then
		echo "invalid number of projects"
		exit 2
	fi
	echo ${proj[@]}
	PROJ_NAME="${proj[0]}"
	PROJ_PATH="${proj[1]}"
	PROJ_STATE="${proj[2]}"

	# if project not exist
	if [[ $PROJ_STATE == 'none' ]]; then
		tmux -d -s $PROJ_NAME -c $PROJ_PATH
	fi

	switch_session -t $PROJ_NAME
	exit
fi

if [[ ! -z "$DEL_PROJ" ]]; then
	# select project name
	read -p "select a project num to remove: " proj
	proj="pos_$proj[@]"
	proj=(${!proj})
	if [[ ${!proj}:-y} == y ]]; then
		echo "invalid number of projects"
		exit 2
	fi
	echo ${proj[@]}
	PROJ_NAME="${proj[0]}"
	PROJ_PATH="${proj[1]}"
	PROJ_STATE="${proj[2]}"

	# if project exist
	if [[ $PROJ_STATE == 'exist' ]]; then
		# delelte session
		tmux kill-session -t $PROJ_NAME
	fi
fi
