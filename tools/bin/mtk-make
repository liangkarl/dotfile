#!/bin/bash

# MIT License
# -----------
# Copyright (c) 2021 Karl Liang
# Permission is hereby granted, free of charge, to any person
# obtaining a copy of this software and associated documentation
# files (the "Software"), to deal in the Software without
# restriction, including without limitation the rights to use,
# copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the
# Software is furnished to do so, subject to the following
# conditions:
#
# The above copyright notice and this permission notice shall be
# included in all copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
# EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
# OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
# NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
# HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
# WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
# FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
# OTHER DEALINGS IN THE SOFTWARE.

import-script io
import-script file

# don't move to botton since 'extglob' needs to be called at first
shopt -s extglob

usage() {
	local name
	name="${1:-$(basename $0 2>&-)}"

	cat<<-USAGE
	NAME:
	    $name - a helper script for MTK build system.

	SYNOPSIS:
	    $name [-k|k|kernel] [-v|v|vendor] [-s|s|system]
	    $name [-m|m|merge] [-mo|mo|merge-ota]
	    $name [-ak|ak|add-kernel config]
	    $name [-av|av|add-vendor config]
	    $name [-as|as|add-system config]
	    $name [-lc|lc|load-config]
	    $name [-dc|dc|del-config]
	    $name [-l|l|list]

	DESCRIPTION:
	    k, v, s - compile kernel, vendor or system
	    m, o - generate whole images or otapackage.zip
	    ak, av, as - setup lunch config of kernel, vendor or system
	    lc - load default build config
	    dc - del runtime build config
	    l - list current config and output dir location. Output
	        dir only appreared after compile source codes.

	EXAMPLE:
	    # compile kernel, vendor, system and merge images
	    $ $name k v s m
	    $ $name ak vnd_qbert-userdebug	 # add kernel config
	    $ $name l		  # show config and output info
	USAGE
}

split_build() {
	local split_build merged_dir
	local cmd out config

	for item in 'kernel' 'vendor' 'system'; do
		out="${item}_out_dir"
		config="${item}_lunch"
		if [[ -z "${!out}" ]]; then
			echo "get product out directory of ${item}"
			lunch ${!config}
			eval ${out}=$ANDROID_PRODUCT_OUT
		fi
	done

	merged_dir="$(readlink -f final-images)"
	split_build=$system_out_dir/images/split_build.py

	rm -rf $merged_dir
	cmd=$(trap -p ERR | awk -F\' '{print $2}')
	trap "${cmd}; rm -rf ${merged_dir}" ERR

	python $split_build \
		--system-dir $system_out_dir/images \
		--vendor-dir $vendor_out_dir/images \
		--kernel-dir $kernel_out_dir/images \
		--output-dir $merged_dir $1
}

build_kernel() {
	lunch $kernel_lunch
	kernel_out_dir=$ANDROID_PRODUCT_OUT
	rm -rf ${kernel_out_dir}/obj/KERNEL_OBJ
	rm -rf ${kernel_out_dir}/images/krn*
	make -j24 krn_images
	# FIXME: move cmd db feature to somewhere else
	# if [[ -e "$(readlink -e "$kernel_dir")" ]]; then
	# 	cmd_list+=("setup_kernel_cmddb $kernel_dir")
	# fi
}

build_system() {
	lunch $system_lunch
	system_out_dir=$ANDROID_PRODUCT_OUT

	rm -rf ${system_out_dir}/obj
	rm -rf ${system_out_dir}/images
	make -j24 sys_images
	# FIXME: move cmd db feature to somewhere else
	# cmd_list+=("create_cmd_db system")
}

build_vendor() {
	lunch $vendor_lunch
	vendor_out_dir=$ANDROID_PRODUCT_OUT

	# avoid to remove kernel obj with same config name
	rm -rf ${vendor_out_dir}/images/vnd*
	rm -rf ${vendor_out_dir}/obj/!(KERNEL_OBJ)
	make -j24 vnd_images
	# FIXME: move cmd db feature to somewhere else
	# cmd_list+=("create_cmd_db vendor")
}

add_build_note_header() {
	cat > $NOTE_HEADER <<-EOF
	# build-info
	* start: $(date '+%D - %T')
	* location: $(pwd)
	* commad: ${EXE_CMD}

	# environment
	* kernel_lunch=${kernel_lunch}
	* vendor_lunch=${vendor_lunch}
	* system_lunch=${system_lunch}

	# note
	EOF
}

add_build_note_content_exp() {
	cat > $NOTE_CONTENT <<-EOF
	[//]: # (Add items with Markdown syntax)
	[//]: # (sorted list: 1., 2.)
	[//]: # (unsorted list: *)
	EOF
}

preview_buildnote() {
	if [[ -e "${NOTE}" ]]; then
		cat <<-PREV
		=== last $NOTE preview ===
		$(mdv $NOTE)
		==========================
		PREV
	else
		echo "no ${NOTE} for previewing"
	fi
}

save_rt_build_conf() {
	cat > $RT_BCONF <<-EOF
	kernel_lunch='${kernel_lunch}'
	vendor_lunch='${vendor_lunch}'
	system_lunch='${system_lunch}'
	kernel_out_dir='${kernel_out_dir}'
	vendor_out_dir='${vendor_out_dir}'
	system_out_dir='${system_out_dir}'
	EOF
}

parse_options() {
	# check input parameters
	if (( $# == 0 )); then
		echo "no more actions"
		exit
	fi

	# TODO: add cleanup RT_BCONF with 'ps'
	while (( $# != 0 )); do
		case "$1" in
			m|-m|merge)
				COMPILE=y
				NEED_MERGE=y
				TARGET_FILES=y
				;;
			o|-o|ota)
				COMPILE=y
				NEED_MERGE=y
				OTA=y
				;;
			k|-k|kernel)
				COMPILE=y
				MAKE_KERNEL=y
				;;
			s|-s|system)
				COMPILE=y
				MAKE_SYSTEM=y
				;;
			v|-v|vendor)
				COMPILE=y
				MAKE_VENDOR=y
				;;
			lc|-lc|load-config)
				CONFIG=y
				USE_DEF_BCONF=y
				;;
			dc|-dc|del-config)
				# not implement yet
				CONFIG=y
				DEL_RT_BCONF=y
				;;
			ak|-ak|add-kernel)
				CONFIG=y
				shift; kernel_lunch="$1"
				kernel_out_dir=''
				echo "kernel lunch: $kernel_lunch"
				;;
			av|-av|add-vendor)
				CONFIG=y
				shift; vendor_lunch="$1"
				vendor_out_dir=''
				echo "vendor lunch: $vendor_lunch"
				;;
			as|-as|add-system)
				CONFIG=y
				shift; system_lunch="$1"
				system_out_dir=''
				echo "system lunch: $system_lunch"
				;;
			l|-l|list)
				cat <<-EOF
				List lunch config:
				kernel: $kernel_lunch
				vendor: $vendor_lunch
				system: $system_lunch
				EOF
				exit 0
				;;
			h|-h|help)
				usage
				exit
				;;
			*)
				usage
				exit 248
		esac
		shift
	done
}

show_menu() {
	local list i

	list=($@)
	echo "Select an option to create build note:"
	for((i = 0; i < ${#list[@]}; i++)); do
		echo "$((i + 1))) ${list[$i]}"
	done
}

add_build_note_content() {
	local def option list

	list=('add-note' 'skip' 'exit')
	def=2	# defualt 'skip'
	show_menu ${list[@]}
	read -p "> ($def) " option

	case ${option:-$def} in
		1|"add-note")
			if [[ ! -e $NOTE_CONTENT ]]; then # new note
				add_build_note_content_exp
			fi
			# go to end of file
			vim "+$" $NOTE_CONTENT
			;;
		2|"skip") # no needs for build note
			;;
		3|"exit")
			exit
			;;
		*)
			pr_err "invalid option: '${option}'"
			exit
			;;
	esac
}

err_act() {
	# substitute variable
	eval pr_err "$ERR_MSG"
	eval $ERR_ACT
}

exit_act() {
	# calculate build elapse time
	BUILD_TIME=$(($(date +%s) - ${BUILD_TIME}))

	# show consumed time
	echo -e "\ntotal consumed time: $(date -d@${BUILD_TIME} -u +%H:%M:%S)"

	# show build note
	mdv $NOTE
	eval $EXIT_ACT
}

config_env() {
	if [[ "${USE_DEF_BCONF}" == y ]]; then
		if [[ ! -e $DEF_BCONF ]]; then
			echo "$DEF_BCONF not found"
			exit 1
		fi
		. $DEF_BCONF
	fi
}

build_code() {
	local args=()

	# start counter
	BUILD_TIME=$(date +%s)

	# show required build info automatically
	trap 'exit_act' EXIT
	trap 'err_act' ERR

	if [[ "${MAKE_KERNEL}" == y ]]; then
		build_kernel
	fi
	if [[ "${MAKE_VENDOR}" == y ]]; then
		build_vendor
	fi
	if [[ "${MAKE_SYSTEM}" == y ]]; then
		build_system
	fi
	if [[ "${NEED_MERGE}" == y ]]; then
		if [[ "${OTA}" == y ]]; then
			args+=('--otapackage')
		fi
		if [[ "${TARGET_FILES}" == y ]]; then
			args+=('--targetfiles')
		fi
		eval split_build ${args[@]}
	fi
}

# Global variables:
## Program variables
ENVSETUP='build/envsetup.sh'
EXE_CMD="$(basename $0) $@"
ERR_MSG='last command: $BASH_SOURCE:$LINENO $BASH_COMMAND'
ERR_ACT=''
BUILD_TIME=''
EXIT_ACT=''
NOTE_HEADER='.note.header'
NOTE_CONTENT='.note.text'
NOTE="buildnote.md"
DEF_BCONF='build.conf'
RT_BCONF=".${PPID}.build.conf"

## Compiliant flags:
MAKE_KERNEL=''
MAKE_VENDOR=''
MAKE_SYSTEM=''
NEED_MERGE=''
OTA=''
COMPILE=''
CONFIG=''

## Config variables:
# kernel_lunch vendor_lunch system_lunch
# kernel_out_dir vendor_out_dir system_out_dir
# kernel_dir

# -a: export all functions
# -e: exit on error
# -E: make ERR trap inherit shell function
# -u: return while meet unset variables
# -o pipefail: return error once failed to execute the first pipline CMD
set -aeE

# load build script & configs
[[ -e $ENVSETUP ]] && . $ENVSETUP
[[ -e $DEF_BCONF ]] && . $DEF_BCONF
[[ -e $RT_BCONF ]] && . $RT_BCONF

# check basic required command
[[ "$(type -t lunch)" != 'function' ]] && {
	echo "no 'lunch' for execution" >&2
	exit 249
}

# parse options
# change to flags, instead of command queue, to prevent ordering problems
# parse_options
parse_options $@

if [[ "$CONFIG" == y ]]; then
	config_env
fi

if [[ "$COMPILE" == y ]]; then
	# preview previous note
	preview_buildnote

	# edit build note
	add_build_note_content

	# write necessary build information
	add_build_note_header

	# merge header & content
	cat $NOTE_HEADER $NOTE_CONTENT > $NOTE

	# start compiling
	build_code
fi

# save runtime lunch config
save_rt_build_conf
