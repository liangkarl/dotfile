#!/bin/bash

# this is for setting up a workspace in tmux

# TARGET_DIR=$(fasd -d $@)
TARGET_NAME="$1"

parse() {
	local sess name argv cmd path
	local sname

	cmd=''
	argv=''
	path="$1"
	sess=($(tmux ls -F'#S' 2>&-))
	if (( $# == 0 )); then
		if (( ${#sess[@]} == 0 )); then
			name=$(date +%x)
			cmd='tmux new'
			argv="-d -s $name -c $HOME"
		fi
	else
		name="$(basename $path)"	# Assume name a path of dir
		for sname in ${sess[@]}; do
			if [[ "$name" == "$sname" ]]; then
				name=''
				break
			fi
		done

		if [[ "$name" != '' ]]; then
			cmd='tmux new'
			argv="-d -s $name"
			if [ -d "$path" ]; then
				argv+=" -c $(cd $path; pwd)"
			fi
		fi
	fi
	$cmd $argv

	# check inside or outside tmux
	if [[ "$TMUX" == '' ]]; then # outside
		cmd='tmux attach'
	else # inside
		TMUX=''
		cmd="tmux switch-client"
	fi
	if [[ "$name" != '' ]]; then
		argv="-t $name"
	fi
	$cmd $argv

	exit $?
}

parse $@
