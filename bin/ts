#!/bin/bash

# this is for setting up a workspace in tmux

# TARGET_DIR=$(fasd -d $@)
TARGET_NAME="$1"

__find_session() {
	local sess

	[[ $# == 0 ]] && return 1

	sess=($(tmux ls -F'#S'))
	[[ ${#sess[@]} == 0 ]] && return 1

	for name in ${sess[@]}; do
		if [[ "$name" == "$1" ]]; then
			return 0
		fi
	done
	return 1
}

parse() {
	local sess target argv cmd
	sess=($(tmux ls -F'#S'))

	cmd=''
	argv=''
	if [[ $# == 0 ]]; then
		# session amount == 0
		if [[ ${#sess[@]} != 0 ]]; then
			target=${sess[0]}
		else
			target=$USER
			cmd='tmux new'
			argv="-d -s $target -c $HOME"
		fi
	else
		target=$1
		if ! __find_session $target; then
			cmd='tmux new'
			argv="-d -s $target"
			[ -d $target ] && argv+=" -c $target"
		fi
	fi
	$cmd $argv

	cmd=''
	argv=''
	if [ -z "$TMUX" ]; then # outside
		cmd='tmux attach'
	else # inside
		TMUX=''
		cmd="tmux switch-client"
	fi
	argv="-t $target"

	unset parse __find_session TARGET_NAME
	$cmd $argv
	# check inside or outside tmux
	exit $?
}

parse $@
