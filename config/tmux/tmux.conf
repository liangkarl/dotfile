# Global tmux setting

## Abbreviations:
# set   : set-option
# setw  : set-window-option
# bind  : bind-key
# unbind: unbind-key

## Unit:
# session > window > layout > pane

# erase all keybinds
# unbind -a

tmux_home="${XDG_CONFIG_HOME}/tmux"
tmux_plugin="${tmux_home}/plugins"
tmux_tool="${tmux_home}/tools"

set -g prefix `	# set ` as prefix key

# solve colorized issue in tmux
# For nvim :checkhealth setting
set -g default-terminal "xterm-256color"
set -ga terminal-overrides ",*256col*:Tc"
# set -g default-terminal "screen-255color"
# set -g default-terminal "tmux-256color"

set -g base-index 1			# set window index to 1
set -g pane-base-index 1	# set pane index to 1
set -g history-limit 20000	# scroll history size
setw -g mode-keys vi		# set copy-mode to vi style
setw -g automatic-rename	# rename window automately
set -sg escape-time 0		# no waiting time
set -g focus-events on		# Used for vim-tmux-clipboard
setw -g monitor-bell on		# monitor bell in the window
setw -g visual-bell on		# show visual alert when task complete
setw -g bell-action other	# only other, not current window, triggers bell
setw -g mode-keys vi

# Add alias for split-window
set -s command-alias[10] vs='split-window -h'
set -s command-alias[11] hs='split-window -v'

## Key mapping
bind ` send-prefix			# press '`' twice => '`'

# Layout:
# - unidirectional switch to next layout
unbind M-1
unbind M-2
unbind M-3
unbind M-4
unbind M-5
unbind Space
bind l next-layout

# Session:
# [x] pop up menu for session operation
bind s choose-tree -sZ -O name			# improve keybind s

# Window:
# - unidirectional switch to next pane
# [x] pop up menu for window operation
# [x] move window
# [x] show window options
unbind p
unbind .
unbind &
bind k confirm-before -p "Do you really want to kill this window? (y/n)" kill-window
bind r move-window -r ';' select-layout -E	# sort the windows
bind w choose-tree -w -f '#{m:#{session_attached},1}'
bind a last-window
bind -r N select-window -n

bind c new-window -a -c "#{pane_current_path}"	# enhance keybind c

# Pane:
# - select-layout -E could only balance the simple layout
# - unidirectional switch to next pane
# [x] pop up menu for pane operation
unbind Up		# Change to the pane above of the current pane.
unbind Down		# Change to the pane below of the current pane.
unbind Left		# Change to the pane left of the current pane.
unbind Right	# Change to the pane right of the current pane.
unbind \"
bind | split-window -h -c "#{pane_current_path}" ';' select-layout -E
unbind %
bind - split-window -v -c "#{pane_current_path}" ';' select-layout -E
bind x kill-pane ';' select-layout -E	# enhance keybind x
unbind o
bind -r n select-pane -t :.+			# enhance keybind n

# Copy-mode:
unbind [
bind v copy-mode
unbind ]
bind p paste-buffer
bind -T copy-mode-vi 'v' send -X begin-selection
bind -T copy-mode-vi 'C-v' send -X rectangle-toggle ';' send -X begin-selection
bind -T copy-mode-vi 'y' send -X copy-selection-and-cancel
bind -T copy-mode-vi Escape send -X cancel

# Misc:
bind [ popup -E -T "Plugin Menu" \
		"tmux new -n plugin ${tmux_tool}/main-menu ';' \
		set status off"
bind o run "${tmux_tool}/debug-console"
bind ? list-keys -T prefix ';' list-keys -T copy-mode-vi
bind j copy-mode ';' send-key ?			# search history from botton
bind , new-window -n 'tmux-profile' nvim ${tmux_home}/tmux.conf

## Plugins
bind ] popup -EE -T "Plugin Menu" \
		"tmux new -n plugin ${tmux_tool}/plugin-menu ';' \
		set status off"

# TPM(tmux plugin manager) itself
set -g @plugin 'tmux-plugins/tpm'

# Prefix + I to install these plugins
set -g @plugin 'tmux-plugins/tmux-sensible'     # Make tmux more sensible
set -g @plugin 'lljbash/tmux-update-display'	# Update $DISPLAY after re-attach a session.
# Kill process with 'prefix + *'
set -g @plugin 'tmux-plugins/tmux-cowboy'		# Kill no-response process in current pane
set -g @plugin 'tmux-plugins/tmux-sessionist'   # more keymap for session
set -g @plugin 'tmux-plugins/tmux-yank'         # Copied text could be used outside tmux
set -g @plugin 'ofirgall/tmux-window-name'      # Name your tmux windows smartly, like IDE's.

set -g @plugin 'fcsonline/tmux-thumbs'
unbind \'							# Prompt for a window index to select.
set -g @thumbs-key "\'"

set -g @plugin 'IngoMeyer441/tmux-easy-motion'
unbind \;							# To last pane
set -g @easy-motion-prefix "\\;"	# '//;' prevent the error of iteration
set -g @easy-motion-target-keys "fjdkslaghrueiwoqptyvncmxzb1234567890"
set -g @easy-motion-default-motion "bd-w"
set -g @easy-motion-dim-style "fg=colour242"
set -g @easy-motion-highlight-style "fg=colour196,bold"
set -g @easy-motion-highlight-2-first-style "fg=brightyellow,bold"
set -g @easy-motion-highlight-2-second-style "fg=yellow,bold"

## Themes
# Dracula: https://draculatheme.com/tmux
set -g @plugin 'dracula/tmux'
# '*' -> current pane, '-' -> previous window, '!' -> bell
set -g @dracula-show-flags true
set -g @dracula-show-left-icon session

# show dracula plugins
# available plugins:
# battery, cpu-usage, gpu-usage, ram-usage, network, network-bandwith,
# weather, time
set -g @dracula-plugins "cpu-usage ram-usage"
set -g @dracula-show-battery false
set -g @dracula-show-network false
set -g @dracula-show-weather false
set -g @dracula-show-time false
set -g @dracula-day-month false
set -g @dracula-ram-usage false
set -g @dracula-cpu-usage false
set -g @dracula-refresh-rate 5

# tmux-gruvbox: https://github.com/egel/tmux-gruvbox
# set -g @plugin 'egel/tmux-gruvbox'
# set -g @tmux-gruvbox 'dark' # or 'light'

# FIXME: WA(?) for WSL2
# https://github.com/microsoft/WSL/issues/5931
set -g escape-time 50

# Wrapped TPM script
run -b ${tmux_home}/bootstrap
